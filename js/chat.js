import { 
  collection, 
  query, 
  where, 
  getDocs 
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

import { db } from "./firebase-config.js";

// üîé Buscar equipamentos no Firestore por status
async function buscarEquipamentosPorStatus(statusBusca) {
  const equipamentosRef = collection(db, "equipamentos");
  const q = query(equipamentosRef, where("status", "==", statusBusca));
  const querySnapshot = await getDocs(q);
  return querySnapshot.docs.map(doc => doc.data().nome);
}

// ---------------- CHATBOT ----------------
const inputChat = document.getElementById("chat-input");
const btnEnviar = document.getElementById("chat-send");
const divMensagens = document.getElementById("chat-messages");
const btnToggle = document.getElementById("btn-toggle-chat");
const chatbot = document.getElementById("chatbot");

// Abrir/fechar chat
btnToggle.addEventListener("click", () => {
  chatbot.style.display = chatbot.style.display === "flex" ? "none" : "flex";
  if (chatbot.style.display === "flex") {
    inputChat.focus();
    if (divMensagens.children.length === 0) {
      exibirMensagem("Ol√°! Eu sou o MaxFit, seu assistente virtual da Academia Corpo Perfeito. üí™ Em que posso te ajudar?", "bot");
    }
  }
});

// ‚úÖ Exibir mensagens (suporta quebras de linha)
function exibirMensagem(texto, remetente) {
  const div = document.createElement("div");
  div.className = `chat-msg ${remetente}`;
  div.innerHTML = texto.replace(/\n/g, "<br>");
  divMensagens.appendChild(div);
  divMensagens.scrollTop = divMensagens.scrollHeight;
}

// ---------------- RESPOSTAS ----------------

// üî• Mais de 50 respostas fixas com sin√¥nimos
const respostas = [
  { chaves: ["hor√°rio", "hora", "funciona", "abre", "fechado"], resposta: [
      "A academia funciona de segunda a sexta das 6h √†s 22h e aos s√°bados das 8h √†s 16h.",
      "Nosso hor√°rio √©: seg a sex das 6h √†s 22h e s√°bado das 8h √†s 16h."
    ] 
  },
  { chaves: ["planos", "pre√ßo", "mensalidade", "valor"], resposta: "Temos 3 planos: B√°sico R$ 69,90, Plus R$ 99,90 e Premium R$ 129,90." },
  { chaves: ["muscula√ß√£o", "peso", "treino de for√ßa"], resposta: "Sim! Temos muscula√ß√£o moderna e acompanhada por profissionais." },
  { chaves: ["zumba"], resposta: "Zumba nas segundas, quartas e sextas √†s 19h." },
  { chaves: ["pilates"], resposta: "Pilates todas as manh√£s √†s 8h." },
  { chaves: ["nutricionista"], resposta: "Temos parceria com nutricionistas. Consulte a recep√ß√£o." },
  { chaves: ["avalia√ß√£o f√≠sica", "avaliar"], resposta: "Fazemos avalia√ß√£o f√≠sica gratuita todo m√™s para alunos ativos." },
  { chaves: ["wifi", "internet"], resposta: "Sim! Temos Wi-Fi gratuito. Solicite a senha na recep√ß√£o." },
  { chaves: ["estacionamento", "carro"], resposta: "Estacionamento gratuito para alunos." },
  { chaves: ["personal", "treinador"], resposta: "Temos personal trainers. Consulte hor√°rios e valores." },
  { chaves: ["vesti√°rio", "banho"], resposta: "Sim! Temos vesti√°rios com chuveiros." },
  { chaves: ["pagamento", "pix", "boleto", "cart√£o"], resposta: "Aceitamos cart√£o, pix, boleto e pagamento recorrente via app." },
  { chaves: ["localiza√ß√£o", "endere√ßo", "onde fica"], resposta: "Estamos localizados na Ponta do Asfalto - Wanderl√¢ndia-TO." },
  { chaves: ["ar-condicionado", "climatizado"], resposta: "Sim! A academia √© climatizada para seu conforto." },
  { chaves: ["√°gua", "bebedouro"], resposta: "Temos bebedouros de √°gua gelada." },
  { chaves: ["tempo de treino", "quanto tempo"], resposta: "O tempo de treino √© livre durante o expediente." },
  { chaves: ["aulas dispon√≠veis", "atividades"], resposta: "Oferecemos zumba, pilates, funcional, HIIT e spinning." },
  { chaves: ["spinning"], resposta: "Spinning ter√ßas e quintas √†s 18h." },
  { chaves: ["hiit"], resposta: "HIIT segundas e quartas √†s 20h." },
  { chaves: ["crossfit"], resposta: "No momento, n√£o oferecemos crossfit." },
  { chaves: ["dan√ßa"], resposta: "Sim! Aulas de dan√ßa focadas em divers√£o e queima cal√≥rica." },
  { chaves: ["descanso", "sof√°"], resposta: "Temos √°rea de conviv√™ncia com sof√°s, revistas e caf√©." },
  { chaves: ["arm√°rio", "locker"], resposta: "Sim! Traga seu cadeado para usar os arm√°rios." },
  { chaves: ["loja", "suplemento"], resposta: "Temos loja com suplementos e acess√≥rios." },
  { chaves: ["chatbot", "como funciona o chat"], resposta: "Sou seu assistente virtual para d√∫vidas r√°pidas. üòÑ" },
  { chaves: ["obrigado", "valeu", "agradecido"], resposta: [
      "Por nada! Estamos √† disposi√ß√£o. üòÑ", 
      "Disponha, sempre por aqui!", 
      "Imagina, estamos juntos! üí™"
    ] 
  },
  { chaves: ["seu nome", "quem √© voc√™"], resposta: "Me chamo CorpoBot, seu assistente da Academia Corpo Perfeito! üí™" },
  { chaves: ["quem criou", "quem te fez"], resposta: "Fui criado pela equipe de tecnologia da academia." },
  { chaves: ["sua fun√ß√£o", "o que voc√™ faz"], resposta: "Respondo d√∫vidas sobre a academia, planos, aulas e equipamentos." },
  { chaves: ["aula experimental", "aula gr√°tis"], resposta: "Sim! Temos aula experimental gratuita. Agende na recep√ß√£o." },
  { chaves: ["idade m√≠nima", "crian√ßa"], resposta: "A idade m√≠nima √© 14 anos, com autoriza√ß√£o dos respons√°veis." },
  { chaves: ["aplicativo", "app"], resposta: "Nosso app permite ver treinos, pagar mensalidade e acompanhar evolu√ß√£o." },
  { chaves: ["treinar em outro hor√°rio"], resposta: "Pode sim! O plano Premium oferece acesso livre." },
  { chaves: ["avalia√ß√£o inicial", "primeira avalia√ß√£o"], resposta: "A avalia√ß√£o inicial √© gratuita com nossos profissionais." },
  { chaves: ["funcional"], resposta: "Funcional √†s ter√ßas e quintas √†s 19h." },
  { chaves: ["plano fam√≠lia", "desconto fam√≠lia"], resposta: "Temos plano fam√≠lia com desconto progressivo." },
  { chaves: ["day use", "pagar por dia"], resposta: "Day use custa R$ 20 para 1 dia completo." },
  { chaves: ["feriado"], resposta: "Nos feriados temos hor√°rio especial, consulte no Instagram." },
  { chaves: ["melhor hora", "hor√°rio vazio"], resposta: "Hor√°rios mais tranquilos: 10h √†s 14h e ap√≥s 20h." },
  { chaves: ["s√°bado"], resposta: "Sim! Aos s√°bados temos treinos livres e aulas especiais." },
  { chaves: ["como funciona o treino"], resposta: "Voc√™ pode treinar sozinho ou com ficha personalizada." },
  { chaves: ["massagem", "relaxamento"], resposta: "Temos massoterapia em parceria, agende na recep√ß√£o." },
  { chaves: ["fisioterapia"], resposta: "Temos fisioterapia para recupera√ß√£o e preven√ß√£o de les√µes." },
  { chaves: ["fotos", "quero ver fotos"], resposta: "Veja fotos no nosso Instagram: @corpoperfeito_academia üì∏" },
  { chaves: ["instagram", "redes sociais"], resposta: "Nos siga no Instagram @corpoperfeito_academia." },
  { chaves: ["lanche", "caf√© da manh√£"], resposta: "Vendemos lanches saud√°veis na loja da academia." },
  { chaves: ["espelho"], resposta: "Temos espelhos grandes na sala de muscula√ß√£o." },
  { chaves: ["cancelar plano", "cancelamento"], resposta: "O cancelamento pode ser feito presencialmente ou pelo app." },
  { chaves: ["seguran√ßa", "c√¢mera"], resposta: "Sim! Temos c√¢meras e controle de acesso para sua seguran√ßa." },
  { chaves: ["certificado"], resposta: "Emitimos certificado em workshops e eventos." },
  { chaves: ["competi√ß√£o", "campeonato"], resposta: "Fazemos desafios internos e campeonatos de tempos em tempos." },
  { chaves: ["nutricional", "nutri"], resposta: "Temos conv√™nio com nutricionistas especializados em performance." }
];

// üé≤ Escolher resposta (aleat√≥ria se for array)
function escolherResposta(resposta) {
  if (Array.isArray(resposta)) {
    const i = Math.floor(Math.random() * resposta.length);
    return resposta[i];
  }
  return resposta;
}

// Procurar resposta fixa
function procurarResposta(pergunta) {
  const p = pergunta.toLowerCase();
  for (let item of respostas) {
    if (item.chaves.some(chave => p.includes(chave))) {
      return escolherResposta(item.resposta);
    }
  }
  return null;
}

// ---------------- PROCESSAMENTO ----------------
async function processarPergunta(pergunta) {
  const p = pergunta.toLowerCase();

  // Firestore din√¢mico numerado
  if (p.includes("manuten√ß√£o")) {
    const emManutencao = await buscarEquipamentosPorStatus("em manuten√ß√£o");
    return emManutencao.length 
      ? `Equipamentos em manuten√ß√£o:\n${emManutencao.map((eq, i) => `${i + 1}. ${eq}`).join("\n")}`
      : "Nenhum equipamento em manuten√ß√£o.";
  }

if (p.includes("quebrado") || p.includes("quebrados") || p.includes("quebrada")) {
  const quebrados = await buscarEquipamentosPorStatus("quebrado"); // Q mai√∫sculo aqui
  return quebrados.length > 0
    ? `Os equipamentos quebrados s√£o: ${quebrados.join(", ")}.`
    : "Nenhum equipamento est√° quebrado.";
}


 if (p.includes("funcionando") || p.includes("operacional") || p.includes("ativos")) {
  const operacionais = await buscarEquipamentosPorStatus("operacional");
  return operacionais.length > 0
    ? `Os equipamentos funcionando normalmente s√£o:${operacionais.join(",")}.`
    : "Nenhum equipamento est√° funcionando no momento.";
}

  // Respostas fixas (sem consultar Firebase)
  if (p.includes("hor√°rio") || p.includes("funciona") || p.includes("horas") || p.includes("")) {
    return "A academia funciona de segunda a sexta das 6h √†s 22h e aos sabados das 8h √†s 16h.";
  }

  if (p.includes("planos") || p.includes("mensalidade") || p.includes("pre√ßo")) {
    return "Temos 3 planos: B√°sico R$ 69,90, e tamb√©m temos o plano Plus R$ 99,90 e o plano Premium R$ 129,90.";
  }

  if (p.includes("muscula√ß√£o")) {
    return "Sim! Temos muscula√ß√£o com equipamentos modernos e acompanhamento profissional.";
  }

  if (p.includes("zumba")) {
    return "Temos aulas de zumba nas segundas, quartas e sextas √†s 19h.";
  }

  if (p.includes("pilates")) {
    return "Temos aulas de pilates todas as manh√£s √†s 8h.";
  }

  if (p.includes("nutricionista")) {
    return "Temos parceria com nutricionistas. Consulte a recep√ß√£o para agendar.";
  }

  if (p.includes("avalia√ß√£o f√≠sica")) {
    return "Sim! Fazemos avalia√ß√£o f√≠sica gratuita todo m√™s para alunos ativos.";
  }

  if (p.includes("wifi")) {
    return "Sim! Temos Wi-Fi gratuito. Solicite a senha na recep√ß√£o.";
  }

  if (p.includes("estacionamento")) {
    return "Sim! Temos estacionamento gratuito para alunos.";
  }

  if (p.includes("personal")) {
    return "Temos personal trainers dispon√≠veis. Consulte hor√°rios e valores.";
  }

  if (p.includes("voc√™ √© real") || p.includes("voc√™ √© humano")) {
    return "Sou um assistente virtual da Academia Corpo Perfeito, feito com carinho. üí™ü§ñ";
  }

  if (p.includes("tem vesti√°rio")) {
    return "Sim! Temos vesti√°rios masculinos e femininos com chuveiros.";
  }

  if (p.includes("forma de pagamento")) {
    return "Aceitamos cart√£o, pix, boleto e pagamento recorrente via app.";
  }

  if (p.includes("como chegar") || p.includes("localiza√ß√£o")) {
    return "Estamos localizados na Ponta do Asfalto - Wanderl√¢ndia-TO.";
  }

  if (p.includes("tem banho")) {
    return "Sim, temos chuveiros dispon√≠veis nos vesti√°rios.";
  }

  if (p.includes("tem ar-condicionado")) {
    return "Sim! O ambiente da academia √© climatizado para seu conforto.";
  }

  if (p.includes("tem √°gua")) {
    return "Temos bebedouros de √°gua gelada dispon√≠veis.";
  }

  if (p.includes("tempo de treino")) {
    return "O tempo de treino √© livre durante o expediente da academia.";
  }

  if (p.includes("aulas dispon√≠veis")) {
    return "Oferecemos aulas de zumba, pilates, funcional, HIIT e spinning.";
  }

  if (p.includes("tem spinning")) {
    return "Sim! As aulas de spinning s√£o ter√ßas e quintas √†s 18h.";
  }

  if (p.includes("tem hiit")) {
    return "Sim! HIIT de alta intensidade √†s segundas e quartas √†s 20h.";
  }

  if (p.includes("tem crossfit")) {
    return "No momento, n√£o oferecemos crossfit.";
  }

  if (p.includes("tem dan√ßa")) {
    return "Sim! Aulas de dan√ßa com foco em queima cal√≥rica e divers√£o!";
  }

  // Respostas fixas
  const resposta = procurarResposta(pergunta);
  if (resposta) return resposta;

  // Padr√£o
  return "Desculpe, n√£o entendi sua pergunta. Pergunte sobre hor√°rios, planos, aulas ou equipamentos.";
}

// ---------------- ENVIO ----------------
async function enviarMensagem() {
  const texto = inputChat.value.trim();
  if (!texto) return;

  exibirMensagem(texto, "user");
  inputChat.value = "";

  // "Digitando..."
  const msgDigitando = document.createElement("div");
  msgDigitando.className = "chat-msg bot";
  msgDigitando.textContent = "Digitando...";
  divMensagens.appendChild(msgDigitando);
  divMensagens.scrollTop = divMensagens.scrollHeight;

  const resposta = await processarPergunta(texto);

  setTimeout(() => {
    msgDigitando.remove();
    exibirMensagem(resposta, "bot");
  }, 1200);
}

btnEnviar.addEventListener("click", enviarMensagem);
inputChat.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    enviarMensagem();
  }
});
